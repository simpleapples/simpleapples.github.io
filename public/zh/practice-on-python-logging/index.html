<!DOCTYPE html>
<html lang="zh" dir="auto">
  <head>
    <script
      src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload"
      data-no-instant
      defer
    ></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="robots" content="noindex, nofollow" />
    <title>Python 日志库 logging 的理解和实践经验 | simpleapples</title>
    <meta name="keywords" content="" />
    <meta
      name="description"
      content="
本文从 Python logging 库的基础概念入手，理解 logging 库的执行流程，以及可能忽视的一些细节。
日志级别
logging 库预置了 5 个错误级别，还有一个 NOTSET 级别，作为 logger 的默认值。
CRITICAL = 50
ERROR = 40
WARNING = 30
INFO = 20
DEBUG = 10
NOTSET = 0
logging 库也支持自定义错误级别，通过上面的源码可以看到，在不同级别的错误中间预留了 10 个数字的位置，方便我们在预置错误级别的基础上添加更细致的错误级别。
import logging


logging.addLevelName(31, &#39;SERIOUS WARNING&#39;)
logger = logging.getLogger(&#39;log&#39;)
logger.warn(&#39;warn info&#39;)
logger.log(logging.getLevelName(&#39;SERIOUS_WARNING&#39;), &#39;serious warn&#39;)
例如添加一个 SERIOUS WARNING 类型的错误，值为 31，就可以用 log 方法输出该级别的错误。
也可以覆盖 logging 预置的错误级别，例如将 WARNING 修改为 SERIOUS WARNING。
logging.addLevelName(30, &#39;SERIOUS WARNING&#39;)
logger = logging.getLogger(&#39;log&#39;)
print(logging.getLevelName(30))  # SERIOUS WARNING
LogRecord、Formatter
logging 库中的每一条 log 都以 LogRecord 的形式存在，当调用 logger 打印 log 时候，都会有一条 LogRecord 被自动创建出来，LogRecord 中包含了大量的和该条日志相关的属性，也包含用户传入的 message。"
    />
    <meta name="author" content="" />
    <link
      rel="canonical"
      href="http://localhost:1313/zh/practice-on-python-logging/"
    />
    <link
      crossorigin="anonymous"
      href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css"
      integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A="
      rel="preload stylesheet"
      as="style"
    />
    <link rel="icon" href="http://localhost:1313/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="http://localhost:1313/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="http://localhost:1313/favicon-32x32.png"
    />
    <link
      rel="apple-touch-icon"
      href="http://localhost:1313/apple-touch-icon.png"
    />
    <link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg" />
    <meta name="theme-color" content="#2e2e33" />
    <meta name="msapplication-TileColor" content="#2e2e33" />
    <link
      rel="alternate"
      hreflang="zh"
      href="http://localhost:1313/zh/practice-on-python-logging/"
    />
    <noscript>
      <style>
        #theme-toggle,
        .top-link {
          display: none;
        }
      </style>
      <style>
        @media (prefers-color-scheme: dark) {
          :root {
            --theme: rgb(29, 30, 32);
            --entry: rgb(46, 46, 51);
            --primary: rgb(218, 218, 219);
            --secondary: rgb(155, 156, 157);
            --tertiary: rgb(65, 66, 68);
            --content: rgb(196, 196, 197);
            --code-block-bg: rgb(46, 46, 51);
            --code-bg: rgb(55, 56, 62);
            --border: rgb(51, 51, 51);
          }

          .list {
            background: var(--theme);
          }

          .list:not(.dark)::-webkit-scrollbar-track {
            background: 0 0;
          }

          .list:not(.dark)::-webkit-scrollbar-thumb {
            border-color: var(--theme);
          }
        }
      </style>
    </noscript>
  </head>

  <body class="" id="top">
    <script>
      if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add("dark");
      } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove("dark");
      } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
        document.body.classList.add("dark");
      }
    </script>

    <header class="header">
      <nav class="nav">
        <div class="logo">
          <a
            href="http://localhost:1313/zh/"
            accesskey="h"
            title="simpleapples (Alt + H)"
            >simpleapples</a
          >
          <div class="logo-switches">
            <button
              id="theme-toggle"
              accesskey="t"
              title="(Alt + T)"
              aria-label="Toggle theme"
            >
              <svg
                id="moon"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                ></path>
              </svg>
              <svg
                id="sun"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
            </button>
            <ul class="lang-switch">
              <li>|</li>
              <li>
                <a
                  href="http://localhost:1313/"
                  title="English"
                  aria-label="English"
                  >En</a
                >
              </li>
            </ul>
          </div>
        </div>
        <ul id="menu">
          <li>
            <a href="http://localhost:1313/zh/about/" title="about">
              <span>about</span>
            </a>
          </li>
          <li>
            <a href="http://localhost:1313/zh/categories/" title="categories">
              <span>categories</span>
            </a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="main">
      <article class="post-single">
        <header class="post-header">
          <h1 class="post-title entry-hint-parent">
            Python 日志库 logging 的理解和实践经验
          </h1>
          <div class="post-meta">
            <span title="2019-01-25 15:18:16 +0000 UTC">一月 25, 2019</span>
          </div>
        </header>
        <div class="post-content">
          <p><img loading="lazy" src="/images/20190125_01.jpg" /></p>
          <p>
            本文从 Python logging 库的基础概念入手，理解 logging
            库的执行流程，以及可能忽视的一些细节。
          </p>
          <h3 id="日志级别">
            日志级别<a hidden class="anchor" aria-hidden="true" href="#日志级别"
              >#</a
            >
          </h3>
          <p>
            logging 库预置了 5 个错误级别，还有一个
            <code>NOTSET</code> 级别，作为 logger 的默认值。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span>CRITICAL <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>ERROR <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>WARNING <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>INFO <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>NOTSET <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre>
          </div>
          <p>
            logging
            库也支持自定义错误级别，通过上面的源码可以看到，在不同级别的错误中间预留了
            10
            个数字的位置，方便我们在预置错误级别的基础上添加更细致的错误级别。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>addLevelName(<span style="color:#ae81ff">31</span>, <span style="color:#e6db74">&#39;SERIOUS WARNING&#39;</span>)
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;log&#39;</span>)
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>warn(<span style="color:#e6db74">&#39;warn info&#39;</span>)
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>log(logging<span style="color:#f92672">.</span>getLevelName(<span style="color:#e6db74">&#39;SERIOUS_WARNING&#39;</span>), <span style="color:#e6db74">&#39;serious warn&#39;</span>)
</span></span></code></pre>
          </div>
          <p>
            例如添加一个 SERIOUS WARNING 类型的错误，值为 31，就可以用 log
            方法输出该级别的错误。
          </p>
          <p>
            也可以覆盖 logging 预置的错误级别，例如将 WARNING 修改为 SERIOUS
            WARNING。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>addLevelName(<span style="color:#ae81ff">30</span>, <span style="color:#e6db74">&#39;SERIOUS WARNING&#39;</span>)
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;log&#39;</span>)
</span></span><span style="display:flex;"><span>print(logging<span style="color:#f92672">.</span>getLevelName(<span style="color:#ae81ff">30</span>))  <span style="color:#75715e"># SERIOUS WARNING</span>
</span></span></code></pre>
          </div>
          <h3 id="logrecordformatter">
            LogRecord、Formatter<a
              hidden
              class="anchor"
              aria-hidden="true"
              href="#logrecordformatter"
              >#</a
            >
          </h3>
          <p>
            logging 库中的每一条 log 都以 LogRecord 的形式存在，当调用 logger
            打印 log 时候，都会有一条 LogRecord 被自动创建出来，LogRecord
            中包含了大量的和该条日志相关的属性，也包含用户传入的 message。
          </p>
          <table>
            <thead>
              <tr>
                <th>属性名</th>
                <th>格式</th>
                <th>描述</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>asctime</td>
                <td><code>%(asctime)s</code></td>
                <td>以可读格式表示的日志创建时间</td>
              </tr>
              <tr>
                <td>created</td>
                <td><code>%(created)f</code></td>
                <td>通过 <code>time.time()</code> 函数获取的日志创建时间</td>
              </tr>
              <tr>
                <td>filename</td>
                <td><code>%(filename)s</code></td>
                <td><code>pathname</code> 中的文件名称部分</td>
              </tr>
              <tr>
                <td>funcName</td>
                <td><code>%(funcName)s</code></td>
                <td>日志输出位置的函数名称</td>
              </tr>
              <tr>
                <td>levelname</td>
                <td><code>%(levelname)s</code></td>
                <td>字符串形式的日志级别</td>
              </tr>
              <tr>
                <td>levelno</td>
                <td><code>%(levelno)s</code></td>
                <td>数字形式的日志级别</td>
              </tr>
              <tr>
                <td>lineno</td>
                <td><code>%(lineno)d</code></td>
                <td>输出日志的源码行号</td>
              </tr>
              <tr>
                <td>message</td>
                <td><code>%(message)s</code></td>
                <td>用户传入的经过格式化的日志内容</td>
              </tr>
              <tr>
                <td>module</td>
                <td><code>%(module)s</code></td>
                <td><code>filename</code> 中的模块名部分</td>
              </tr>
              <tr>
                <td>msecs</td>
                <td><code>%(msecs)d</code></td>
                <td>日志创建时间的毫秒部分</td>
              </tr>
              <tr>
                <td>name</td>
                <td><code>%(name)s</code></td>
                <td>logger 的名称</td>
              </tr>
              <tr>
                <td>pathname</td>
                <td><code>%(pathname)s</code></td>
                <td>源码的路径</td>
              </tr>
              <tr>
                <td>process</td>
                <td><code>%(process)d</code></td>
                <td>进程 ID</td>
              </tr>
              <tr>
                <td>processName</td>
                <td><code>%(processName)s</code></td>
                <td>进程名</td>
              </tr>
              <tr>
                <td>relativeCreated</td>
                <td><code>%(relativeCreated)d</code></td>
                <td>相对于 logging 模块加载时间的毫秒数</td>
              </tr>
              <tr>
                <td>thread</td>
                <td><code>%(thread)d</code></td>
                <td>线程 ID</td>
              </tr>
              <tr>
                <td>threadName</td>
                <td><code>%(threadName)s</code></td>
                <td>线程名</td>
              </tr>
            </tbody>
          </table>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;log&#39;</span>)
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#39;a warning message&#39;</span>)  <span style="color:#75715e"># a warning message</span>
</span></span></code></pre>
          </div>
          <p>
            执行上述代码，会发现，logger 并没有输出列表中列出的 LogRecord
            的各种属性，只有 message 内容。因为 LogRecord
            只是承载每条日志内容和属性的对象，在一条 log
            产生的时候就被创建了，而日志的输出格式则是在被输出时才确定，由
            Formatter 来控制。Formatter 负责将一条 log（以 LogRecord
            对象的形式存在）转换为可读的字符串，默认情况下，格式是<code>%(message)s</code>，所以当没有指定
            Formatter 时，只输出用户传入的内容。
          </p>
          <h3 id="loggerhandlerfilter">
            Logger、Handler、Filter<a
              hidden
              class="anchor"
              aria-hidden="true"
              href="#loggerhandlerfilter"
              >#</a
            >
          </h3>
          <p>
            Logger 对象是 logging 库中最为常用的对象，Logger
            对象的作用主要有三个：
          </p>
          <ol>
            <li>
              为应用暴露出 info、warning、error
              等方法，应用可以通过这些方法创建对应级别的日志。
            </li>
            <li>
              根据 Filter
              和日志级别的设置，来决定哪些日志可以被传入给下一个流程处理，
            </li>
            <li>将日志传递到所有相关的 Handler 中。</li>
          </ol>
          <p>
            同时 Logger 对象还可以继承，一个 Logger 可以把 LogRecord
            传递给父级的 Logger。
          </p>
          <p>
            Handler
            负责将日志写入到最终的归宿，可能文件、电子邮件、内存、队列&hellip;
            由于一个 Logger 可以有多个 Handler，所以每个 Handler
            都可以设置接收日志的级别和
            Filter，换句话说，不同级别的日志可以输出到不同的归宿。
          </p>
          <p>Python 官方文档提供了 logging 处理日志的逻辑流程图。</p>
          <p><img loading="lazy" src="/images/20190125_02.png" /></p>
          <p>
            这里我们可能会有一个疑问，为 Logger 和 Handler
            设置日志级别已经可以表示处理哪些日志，不处理哪些日志，为什么还需要
            Filter 呢？
          </p>
          <p>
            相比于日志级别，Filter 可定制性更丰富，可以在 Logger 和 Handler
            上实现颗粒度更细的控制。例如希望只记录长度大于 10
            的日志，可以用如下的代码实现。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomFilter</span>(logging<span style="color:#f92672">.</span>Filterer):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">filter</span>(self, record):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> len(record<span style="color:#f92672">.</span>msg) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;log&#39;</span>)
</span></span><span style="display:flex;"><span>filter <span style="color:#f92672">=</span> CustomFilter()
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>addFilter(filter)
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#39;a warning message&#39;</span>)  <span style="color:#75715e"># a warning message</span>
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#39;a warn&#39;</span>)
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#39;another warning message&#39;</span>)  <span style="color:#75715e"># another warning message</span>
</span></span></code></pre>
          </div>
          <p>长度小于 10 的第二条 log 并不会被输出。</p>
          <h3 id="实践中的一些经验">
            实践中的一些经验<a
              hidden
              class="anchor"
              aria-hidden="true"
              href="#实践中的一些经验"
              >#</a
            >
          </h3>
          <p>
            在使用 Python logging
            库的过程中，我们发现了一些容易容易忽视的细节，这些细节可能会导致一些预期之外的情况，在此做以总结。
          </p>
          <h4 id="logger-的继承链">
            Logger 的继承链<a
              hidden
              class="anchor"
              aria-hidden="true"
              href="#logger-的继承链"
              >#</a
            >
          </h4>
          <p>
            Logger 对象是有一条继承链的，使用
            <code>logging.getLogger()</code> 方法获取 logger 时，获取的是 root
            logger。如果为 getLogger 方法传入参数，获取的是子 logger。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span>root_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger()
</span></span><span style="display:flex;"><span>sub_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;log&#39;</span>)
</span></span><span style="display:flex;"><span>print(sub_logger<span style="color:#f92672">.</span>parent <span style="color:#f92672">==</span> root_logger)  <span style="color:#75715e"># True</span>
</span></span></code></pre>
          </div>
          <p>
            logging 的官方文档中推荐使用 <code>__name__</code> 作为 getLogger
            的参数，<code>__name__</code> 是 module 的路径名，例如在 utils.log
            包中使用 <code>logging.getLogger(__name___)</code> 相当于执行
            <code>logging.getLogger('base.db')</code>，这样就创建了一个名为
            base.db 的 logger，这个 db 包的 logger 继承自 root logger。
          </p>
          <p>
            如果我们在 base 中也创建一个
            logger，<code>logger.getLogger('base')</code>，这时候，base logger
            也继承自 root logger，但是 db logger 的继承顺序则被修改成了继承自
            base logger。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span>root_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger()
</span></span><span style="display:flex;"><span>db_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;base.db&#39;</span>)
</span></span><span style="display:flex;"><span>print(db_logger<span style="color:#f92672">.</span>name)  <span style="color:#75715e"># base.db</span>
</span></span><span style="display:flex;"><span>print(db_logger<span style="color:#f92672">.</span>parent<span style="color:#f92672">.</span>name)  <span style="color:#75715e"># root</span>
</span></span><span style="display:flex;"><span>base_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;base&#39;</span>)  <span style="color:#75715e"># base</span>
</span></span><span style="display:flex;"><span>print(db_logger<span style="color:#f92672">.</span>name)  <span style="color:#75715e"># base.db</span>
</span></span><span style="display:flex;"><span>print(db_logger<span style="color:#f92672">.</span>parent<span style="color:#f92672">.</span>name)  <span style="color:#75715e"># base</span>
</span></span></code></pre>
          </div>
          <p>
            换句话说我们可以通过 xxx.xxx 的形式获取任何一级的
            logger，但是这些中间层的 logger 并不一定是存在的。
          </p>
          <h4 id="logger-奇葩的默认行为">
            Logger 奇葩的默认行为<a
              hidden
              class="anchor"
              aria-hidden="true"
              href="#logger-奇葩的默认行为"
              >#</a
            >
          </h4>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span>root_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger()
</span></span><span style="display:flex;"><span>root_logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;root info&#39;</span>)
</span></span></code></pre>
          </div>
          <p>
            执行上面的代码，会发现没有任何输出，但是如果打一个 warning 级别的
            log，是可以输出的。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span>root_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger()
</span></span><span style="display:flex;"><span>sub_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;sub&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(root_logger<span style="color:#f92672">.</span>level)  <span style="color:#75715e"># 30 = WARNING</span>
</span></span><span style="display:flex;"><span>print(sub_logger<span style="color:#f92672">.</span>level)  <span style="color:#75715e"># 0 = NOTSET</span>
</span></span></code></pre>
          </div>
          <p>
            打印一下 root logger 的默认级别，会发现 30 对应的是
            WARNING，也就是说，只有比 WARNING 高的级别才会被输出出来，而 INFO
            对应值是 20， 比 WARNING 低，所以默认情况下 root logger 将不会接受
            INFO 级别的错误。
          </p>
          <p>
            但是只有 root logger 的默认级别是 WARNING，其他 logger 的默认级别 是
            NOTSET = 0。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span>root_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger()
</span></span><span style="display:flex;"><span>sub_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;sub&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root_logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;root info&#39;</span>)
</span></span><span style="display:flex;"><span>sub_logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;sub info&#39;</span>)
</span></span></code></pre>
          </div>
          <p>
            执行上面代码，会发现依然没有任何输出，既然其他 logger 的默认级别是
            NOTSET，为什么比 NOTSET 高的 INFO 还是不会输出呢？
          </p>
          <p>
            当一个 logger 的 level 被设置为 NOTSET 时，如果有父 logger，会将 log
            传递给父 logger 处理，只有在 logger 是 root logger 或 propagate
            属性设置为 False 时，才会由自己处理。接下来再修改一下上面的代码。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;sub&#39;</span>)
</span></span><span style="display:flex;"><span>sub_logger<span style="color:#f92672">.</span>propagate <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub_logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;sub info&#39;</span>)
</span></span><span style="display:flex;"><span>sub_logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#39;sub warn&#39;</span>)  <span style="color:#75715e"># sub warn</span>
</span></span></code></pre>
          </div>
          <p>
            上面的代码中禁用了 logger 的传递功能，所以 logger
            会自己处理错误，但是 INFO 级别的日志依然没有被输出，如果输出一下
            sub_logger.handlers 属性，会发现默认情况下 logger 并没有任何的
            handlers，这能解释为什么无法输出日志，但是下一行代码输出了 WARNING
            级别的日志，显然又是和这个猜测违背的，原因到底是什么呢？
          </p>
          <p>
            跟踪源码会发现，当一个 logger 需要自己处理日志时且没有任何一个
            handler 时，会尝试使用 lastResort 属性所存储的 handler 来处理。
          </p>
          <p>文档中是这样定义 lastResort 的。</p>
          <blockquote>
            <p>
              A “handler of last resort” is available through this attribute.
              This is a StreamHandler writing to sys.stderr with a level of
              WARNING, and is used to handle logging events in the absence of
              any logging configuration. The end result is to just print the
              message to sys.stderr. This replaces the earlier error message
              saying that “no handlers could be found for logger XYZ”. If you
              need the earlier behaviour for some reason, lastResort can be set
              to None.
            </p>
          </blockquote>
          <p>
            所以，当一个 logger 没有任何 handler 的时候，依然能输出 WARNING
            及以上级别的日志。
          </p>
          <h3 id="参考资料">
            参考资料<a hidden class="anchor" aria-hidden="true" href="#参考资料"
              >#</a
            >
          </h3>
          <p>
            <a href="https://juejin.im/post/5bc2bd3a5188255c94465d31"
              >Python日志库logging总结-可能是目前为止将logging库总结的最好的一篇文章
              - 掘金</a
            >
          </p>
          <p>
            <a href="https://docs.python.org/3/library/logging.html"
              >logging — Logging facility for Python</a
            >
          </p>
          <p>
            <a href="https://docs.python.org/3.7/howto/logging.html"
              >Logging HOWTO</a
            >
          </p>
        </div>

        <footer class="post-footer">
          <ul class="post-tags"></ul>
        </footer>
      </article>
    </main>

    <footer class="footer">
      <span
        >&copy; 2025 <a href="http://localhost:1313/zh/">simpleapples</a></span
      >
      ·

      <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank"
          >Hugo</a
        >
        &
        <a
          href="https://github.com/adityatelange/hugo-PaperMod/"
          rel="noopener"
          target="_blank"
          >PaperMod</a
        >
      </span>
    </footer>
    <a
      href="#top"
      aria-label="go to top"
      title="Go to Top (Alt + G)"
      class="top-link"
      id="top-link"
      accesskey="g"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 12 6"
        fill="currentColor"
      >
        <path d="M12 6H0l6-6z" />
      </svg>
    </a>

    <script>
      let menu = document.getElementById("menu");
      if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
          localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        };
      }

      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
          e.preventDefault();
          var id = this.getAttribute("href").substr(1);
          if (!window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
            document
              .querySelector(`[id='${decodeURIComponent(id)}']`)
              .scrollIntoView({
                behavior: "smooth",
              });
          } else {
            document
              .querySelector(`[id='${decodeURIComponent(id)}']`)
              .scrollIntoView();
          }
          if (id === "top") {
            history.replaceState(null, null, " ");
          } else {
            history.pushState(null, null, `#${id}`);
          }
        });
      });
    </script>
    <script>
      var mybutton = document.getElementById("top-link");
      window.onscroll = function () {
        if (
          document.body.scrollTop > 800 ||
          document.documentElement.scrollTop > 800
        ) {
          mybutton.style.visibility = "visible";
          mybutton.style.opacity = "1";
        } else {
          mybutton.style.visibility = "hidden";
          mybutton.style.opacity = "0";
        }
      };
    </script>
    <script>
      document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
          document.body.classList.remove("dark");
          localStorage.setItem("pref-theme", "light");
        } else {
          document.body.classList.add("dark");
          localStorage.setItem("pref-theme", "dark");
        }
      });
    </script>
  </body>
</html>
