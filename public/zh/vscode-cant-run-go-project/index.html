<!DOCTYPE html>
<html lang="zh" dir="auto">
  <head>
    <script
      src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload"
      data-no-instant
      defer
    ></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="robots" content="noindex, nofollow" />
    <title>探究vscode debug流程，解决无法运行go程序的问题 | simpleapples</title>
    <meta name="keywords" content="" />
    <meta
      name="description"
      content="问题描述
vscode 无法以 run 模式运行 go 项目（只能以 debug 模式调试），并且有如下报错。

图中被遮盖的部分是项目内的 package，并非第三方 package，也就是说在以 run 模式运行 go 项目时无法找到其他的 go 文件，只能找到入口文件。
初步排查
找不到其他文件，首先想到的是 GO_PATH 的问题，但是项目使用了 go mod，允许在 GO_PATH 之外的路径创建项目，所以这个怀疑点排除。接下来怀疑 vscode 的配置有问题，每个 vscode 项目中都有 .launch.json 文件，配置运行代码时的环境，下面是项目中的 .launch.json。
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    &#34;version&#34;: &#34;0.2.0&#34;,
    &#34;configurations&#34;: [
        {
            &#34;name&#34;: &#34;Launch&#34;,
            &#34;type&#34;: &#34;go&#34;,
            &#34;request&#34;: &#34;launch&#34;,
            &#34;mode&#34;: &#34;auto&#34;,
            &#34;program&#34;: &#34;${workspaceRoot}/src/main.go&#34;,
            &#34;env&#34;: {},
            &#34;args&#34;: []
        }
    ]
}
可以看到 .launch.json 里没有指定程序的工作目录，debug 模式和 run 模式会不会默认的工作路径不同呢？于是在 main 函数里使用 os.Getwd() 打印一下当前的路径，结果如下："
    />
    <meta name="author" content="" />
    <link
      rel="canonical"
      href="http://localhost:1313/zh/vscode-cant-run-go-project/"
    />
    <link
      crossorigin="anonymous"
      href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css"
      integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A="
      rel="preload stylesheet"
      as="style"
    />
    <link rel="icon" href="http://localhost:1313/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="http://localhost:1313/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="http://localhost:1313/favicon-32x32.png"
    />
    <link
      rel="apple-touch-icon"
      href="http://localhost:1313/apple-touch-icon.png"
    />
    <link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg" />
    <meta name="theme-color" content="#2e2e33" />
    <meta name="msapplication-TileColor" content="#2e2e33" />
    <link
      rel="alternate"
      hreflang="zh"
      href="http://localhost:1313/zh/vscode-cant-run-go-project/"
    />
    <noscript>
      <style>
        #theme-toggle,
        .top-link {
          display: none;
        }
      </style>
      <style>
        @media (prefers-color-scheme: dark) {
          :root {
            --theme: rgb(29, 30, 32);
            --entry: rgb(46, 46, 51);
            --primary: rgb(218, 218, 219);
            --secondary: rgb(155, 156, 157);
            --tertiary: rgb(65, 66, 68);
            --content: rgb(196, 196, 197);
            --code-block-bg: rgb(46, 46, 51);
            --code-bg: rgb(55, 56, 62);
            --border: rgb(51, 51, 51);
          }

          .list {
            background: var(--theme);
          }

          .list:not(.dark)::-webkit-scrollbar-track {
            background: 0 0;
          }

          .list:not(.dark)::-webkit-scrollbar-thumb {
            border-color: var(--theme);
          }
        }
      </style>
    </noscript>
  </head>

  <body class="" id="top">
    <script>
      if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add("dark");
      } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove("dark");
      } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
        document.body.classList.add("dark");
      }
    </script>

    <header class="header">
      <nav class="nav">
        <div class="logo">
          <a
            href="http://localhost:1313/zh/"
            accesskey="h"
            title="simpleapples (Alt + H)"
            >simpleapples</a
          >
          <div class="logo-switches">
            <button
              id="theme-toggle"
              accesskey="t"
              title="(Alt + T)"
              aria-label="Toggle theme"
            >
              <svg
                id="moon"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                ></path>
              </svg>
              <svg
                id="sun"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
            </button>
            <ul class="lang-switch">
              <li>|</li>
              <li>
                <a
                  href="http://localhost:1313/"
                  title="English"
                  aria-label="English"
                  >En</a
                >
              </li>
            </ul>
          </div>
        </div>
        <ul id="menu">
          <li>
            <a href="http://localhost:1313/zh/about/" title="about">
              <span>about</span>
            </a>
          </li>
          <li>
            <a href="http://localhost:1313/zh/categories/" title="categories">
              <span>categories</span>
            </a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="main">
      <article class="post-single">
        <header class="post-header">
          <h1 class="post-title entry-hint-parent">
            探究vscode debug流程，解决无法运行go程序的问题
          </h1>
          <div class="post-meta">
            <span title="2020-04-20 15:35:00 +0000 +0000">四月 20, 2020</span>
          </div>
        </header>
        <div class="post-content">
          <h3 id="问题描述">
            问题描述<a hidden class="anchor" aria-hidden="true" href="#问题描述"
              >#</a
            >
          </h3>
          <p>
            vscode 无法以 <code>run</code> 模式运行 go 项目（只能以
            <code>debug</code> 模式调试），并且有如下报错。
          </p>
          <p><img loading="lazy" src="/images/20200420_01.png" /></p>
          <p>
            图中被遮盖的部分是项目内的 package，并非第三方 package，也就是说在以
            <code>run</code> 模式运行 go 项目时无法找到其他的 go
            文件，只能找到入口文件。
          </p>
          <h3 id="初步排查">
            初步排查<a hidden class="anchor" aria-hidden="true" href="#初步排查"
              >#</a
            >
          </h3>
          <p>
            找不到其他文件，首先想到的是 GO_PATH 的问题，但是项目使用了 go
            mod，允许在 GO_PATH
            之外的路径创建项目，所以这个怀疑点排除。接下来怀疑 vscode
            的配置有问题，每个 vscode 项目中都有 .launch.json
            文件，配置运行代码时的环境，下面是项目中的 .launch.json。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Use IntelliSense to learn about possible attributes.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Hover to view descriptions of existing attributes.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;0.2.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;configurations&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Launch&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;go&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;request&#34;</span>: <span style="color:#e6db74">&#34;launch&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;mode&#34;</span>: <span style="color:#e6db74">&#34;auto&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;program&#34;</span>: <span style="color:#e6db74">&#34;${workspaceRoot}/src/main.go&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;env&#34;</span>: {},
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;args&#34;</span>: []
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
          </div>
          <p>
            可以看到 .launch.json 里没有指定程序的工作目录，<code>debug</code>
            模式和 <code>run</code> 模式会不会默认的工作路径不同呢？于是在 main
            函数里使用 <code>os.Getwd()</code> 打印一下当前的路径，结果如下：
          </p>
          <ul>
            <li><code>debug</code> 模式：项目所在目录</li>
            <li><code>run</code> 模式：用户目录</li>
          </ul>
          <p>
            基本可以确认，<code>run</code>
            模式下的工作路径设置不正确，导致找不到路径。在 .launch.json 中加入
            <code>cwd</code> 参数，手动填入项目路径。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Use IntelliSense to learn about possible attributes.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Hover to view descriptions of existing attributes.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;0.2.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;configurations&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Launch&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;go&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;request&#34;</span>: <span style="color:#e6db74">&#34;launch&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;mode&#34;</span>: <span style="color:#e6db74">&#34;auto&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;program&#34;</span>: <span style="color:#e6db74">&#34;${workspaceRoot}/src/main.go&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;cwd&#34;</span>: <span style="color:#e6db74">&#34;${workspaceRoot}&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;env&#34;</span>: {},
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;args&#34;</span>: []
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
          </div>
          <p>
            但是修改 .launch.json
            后运行程序，输出的工作目录仍然是用户目录，<code>cwd</code>
            参数并没有生效。
          </p>
          <h3 id="探究-vscode-的-debug-流程">
            探究 vscode 的 debug 流程<a
              hidden
              class="anchor"
              aria-hidden="true"
              href="#探究-vscode-的-debug-流程"
              >#</a
            >
          </h3>
          <p>
            至此，bug 的气息越来越浓厚，<code>cwd</code>
            参数没有生效，肯定有问题！
          </p>
          <p>
            一不做二不休，索性看看 vscode
            的调试流程吧，用一个很暴力的方式，看看点击运行按钮后，vscode
            到底是如何运行 go 程序的。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10000000000</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
          </div>
          <p>运行程序后，使用 <code>ps -ef|grep go</code> 查看进程。</p>
          <p><img loading="lazy" src="/images/20200420_02.jpg" /></p>
          <p>
            截图中三个进程从上到下均是父子关系，也就是说在 vscode 中即便使用
            <code>run</code> 模式运行，也不是直接执行
            <code>go run xxxx.go</code>，这与 Goland 等其他 IDE
            的行为是不同的。vscode 首先调用了 language server 中的 node，执行了
            go extention（vscode 的 go 扩展，安装后才支持 go 语言项目）中的一个
            <code>goDebug.js</code>，而后 <code>goDebug.js</code> 中调用了
            <code>go run xxxx.go</code>。（图中 /tmp 路径下的 main 文件是 go run
            执行过程中生成的二进制文件）
          </p>
          <p>
            接下来查看 <code>goDebug.js</code> 的逻辑，找到了调用
            <code>go run</code> 的代码。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">debugProcess</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">spawn</span>(<span style="color:#a6e22e">getBinPathWithPreferredGopath</span>(<span style="color:#e6db74">&#39;go&#39;</span>, []), <span style="color:#a6e22e">runArgs</span>, { <span style="color:#a6e22e">env</span> });
</span></span></code></pre>
          </div>
          <p>
            查看代码上面几行的逻辑，根据参数的命名，可以猜测出来，.launch.json
            中的配置在这里是可以获取到的。接下来直接修改 js
            文件，进行调试，证实上述的猜测，由于我们无法直接看到 node goDebug.js
            的输出，所以通过写入文件的方式进行调试。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">writeFile</span>(<span style="color:#e6db74">&#39;test.log&#39;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">debugProcess</span>.<span style="color:#a6e22e">cwd</span>(), <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">err</span>) {}
</span></span></code></pre>
          </div>
          <p>
            加入这句后再次运行，我们可以看到 test.log
            文件中已经打印出了这个进程的工作路径，也就是 go run
            的工作路径，是用户目录。至此，可以将问题缩小到：在 node 调用 go run
            时没有将 .launch.json 文件中的 cwd 传给子进程（go run）。
          </p>
          <p>
            <code>spawn</code> 是 nodejs 中的函数，看一下 spawn
            的文档可以发现，spawn 有三个参数
            <code>child_process.spawn(command[, args][, options])</code>
            第三个参数 options 中可以指定 cwd 工作路径。而
            <code>goDebug.js</code> 这段启动子进程的代码并没有设置
            cwd，只设置了<code>env</code> 参数，这就是
            <code>run</code> 模式无法运行 go 程序的原因。
          </p>
          <p><img loading="lazy" src="/images/20200420_03.jpg" /></p>
          <h3 id="解决方案">
            解决方案<a hidden class="anchor" aria-hidden="true" href="#解决方案"
              >#</a
            >
          </h3>
          <p>
            在发现这个问题时，vscode go
            extention的最新版本是0.13，这个问题暂时只能通过修改 goDebug.js
            的源码解决，如下图所示加入注释中的代码，将
            <code>cwd</code> 参数传入子进程，就可以解决问题。
          </p>
          <p><img loading="lazy" src="/images/20200420_04.png" /></p>
          <p>
            同时，这个 bug 已经被解决，可以参考
            <a href="https://github.com/microsoft/vscode-go/issues/3096"
              >ISSUE #3096</a
            >，程序员在解决另一个问题这个 ISSUE 的问题时，“顺手”把
            <code>cwd</code> 的问题修复了。在 vscode go extention
            0.14版发布后（已发布），将 go extension
            更新到最新版就可以正常运行和调试 go 项目了。
          </p>
          <h3 id="参考资料">
            参考资料<a hidden class="anchor" aria-hidden="true" href="#参考资料"
              >#</a
            >
          </h3>
          <p>
            <a href="https://code.visualstudio.com/docs/editor/debugging"
              >Debugging in Visual Studio Code</a
            >
          </p>
          <p>
            <a
              href="https://nodejs.org/api/child_process.html#child_process_child_process_spawn_command_args_options"
              >Node.js v13.13.0 Documentation</a
            >
          </p>
          <p>
            <a href="https://github.com/microsoft/vscode-go/issues/3096"
              >Debug: add &ldquo;go run .&rdquo; support #3096</a
            >
          </p>
        </div>

        <footer class="post-footer">
          <ul class="post-tags"></ul>
        </footer>
      </article>
    </main>

    <footer class="footer">
      <span
        >&copy; 2025 <a href="http://localhost:1313/zh/">simpleapples</a></span
      >
      ·

      <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank"
          >Hugo</a
        >
        &
        <a
          href="https://github.com/adityatelange/hugo-PaperMod/"
          rel="noopener"
          target="_blank"
          >PaperMod</a
        >
      </span>
    </footer>
    <a
      href="#top"
      aria-label="go to top"
      title="Go to Top (Alt + G)"
      class="top-link"
      id="top-link"
      accesskey="g"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 12 6"
        fill="currentColor"
      >
        <path d="M12 6H0l6-6z" />
      </svg>
    </a>

    <script>
      let menu = document.getElementById("menu");
      if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
          localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        };
      }

      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
          e.preventDefault();
          var id = this.getAttribute("href").substr(1);
          if (!window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
            document
              .querySelector(`[id='${decodeURIComponent(id)}']`)
              .scrollIntoView({
                behavior: "smooth",
              });
          } else {
            document
              .querySelector(`[id='${decodeURIComponent(id)}']`)
              .scrollIntoView();
          }
          if (id === "top") {
            history.replaceState(null, null, " ");
          } else {
            history.pushState(null, null, `#${id}`);
          }
        });
      });
    </script>
    <script>
      var mybutton = document.getElementById("top-link");
      window.onscroll = function () {
        if (
          document.body.scrollTop > 800 ||
          document.documentElement.scrollTop > 800
        ) {
          mybutton.style.visibility = "visible";
          mybutton.style.opacity = "1";
        } else {
          mybutton.style.visibility = "hidden";
          mybutton.style.opacity = "0";
        }
      };
    </script>
    <script>
      document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
          document.body.classList.remove("dark");
          localStorage.setItem("pref-theme", "light");
        } else {
          document.body.classList.add("dark");
          localStorage.setItem("pref-theme", "dark");
        }
      });
    </script>
  </body>
</html>
