<!DOCTYPE html>
<html lang="zh" dir="auto">
  <head>
    <script
      src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload"
      data-no-instant
      defer
    ></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="robots" content="noindex, nofollow" />
    <title>viper从etcd读取配置失败的问题 | simpleapples</title>
    <meta name="keywords" content="" />
    <meta
      name="description"
      content="问题描述
Viper （本文环境是Viper 1.1.0）是Go应用程序的完整配置解决方案，在很多项目中都有应用。etcd是一个分布式KV存储，最直接的应用是配置中心。
Viper除了支持从文件中读取配置，还支持从远程的配置中心读取配置，使用下面的代码进行配置。
viper.AddRemoteProvider(&#34;etcd&#34;,
        &#34;http://127.0.0.1:2379&#34;,
        &#34;conf.toml&#34;)
viper.SetConfigType(&#34;toml&#34;)
err := viper.ReadRemoteConfig()
if err != nil {
    panic(err)
}
运行后报错panic: Remote Configurations Error: No Files Found，检查后发现etcd开启了tls，所以需要用https协议访问etcd的API，更新代码如下。
viper.AddSecureRemoteProvider(&#34;etcd&#34;,
        &#34;https://127.0.0.1:2379&#34;,
        &#34;conf.toml&#34;,
        &#34;key_path&#34;)
viper.SetConfigType(&#34;toml&#34;)
err := viper.ReadRemoteConfig()
if err != nil {
    panic(err)
}
使用AddSecureRemoteProvider方法替换AddRemoteProvider方法，问题依旧。
定位问题
跟踪源码发现，最终像etcd发送请求的是go-etcd包（目前go-etcd已经不维护），在go-etcd的requests.go文件中找到了相关的源码，go-etcd调用了net/http包向etcd发送请求。

这个时候忽然想到etcd的证书是自签名的，访问自签名证书的https接口应该会报错啊，怎么会请求到内容呢？如下图，在Chrome中访问etcd的自签名https接口，会提示证书无效。

我们自己使用go实现一段请求etcd https接口的代码，看看到底是什么回事，代码如下。
resp, err := http.Get(&#34;https://127.0.0.1:2379/v2/keys/conf.toml?quorum=false&amp;recursive=false&amp;sorted=false&#34;)
    if err != nil {
        // handle error
        fmt.Println(err)
    }
    defer resp.Body.Close()
    body, err := ioutil.ReadAll(resp.Body)
    if err != nil {
        fmt.Println(err)
    }
    fmt.Println(string(body))
果然不一样，我们的代码会报错x509: certificate signed by unknown authority，因为是自签名证书，客户端无法验证证书真假，所以这个报错是可以理解的，go-etcd代码和我们的测试代码表现不一致，一定是我们落下了什么，重新梳理go-etcd源码终于发现了原因。

在client.go文件的initHTTPSClient方法中，发现允许绕过证书验证，这就可以解释为什么证书无效也能获取到数据了，绕过了证书的验证环节，相当于不管证书真假都拿来用。现在可以解释使用AddRemoteProvider方法访问https接口为什么可以获取到内容，但是无法解释AddSecureRemoteProvider方法为什么无法从https接口获取内容，因为两个方法在发送http请求阶段的代码是一致的，都忽略了证书验证。
查看AddSecureRemoteProvider的注释，发现了原因。

原来&hellip;AddSecureRemoteProvider这个Secure指的并不是使用安全链接https，而是在请求到内容后加了一个解密的步骤（Secure指请求的是加密过的内容，而不是使用加密链接请求），最后一个参数接收的也并不是客户端证书，而是解密的gpg key&hellip; 根据viper的文档，这个gpg key是可选的，我们这个例子中，如果给gpg key传入一个空字符串，也是可以正常执行的&hellip;"
    />
    <meta name="author" content="" />
    <link
      rel="canonical"
      href="http://localhost:1313/zh/viper-read-from-etcd-failed/"
    />
    <link
      crossorigin="anonymous"
      href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css"
      integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A="
      rel="preload stylesheet"
      as="style"
    />
    <link rel="icon" href="http://localhost:1313/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="http://localhost:1313/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="http://localhost:1313/favicon-32x32.png"
    />
    <link
      rel="apple-touch-icon"
      href="http://localhost:1313/apple-touch-icon.png"
    />
    <link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg" />
    <meta name="theme-color" content="#2e2e33" />
    <meta name="msapplication-TileColor" content="#2e2e33" />
    <link
      rel="alternate"
      hreflang="zh"
      href="http://localhost:1313/zh/viper-read-from-etcd-failed/"
    />
    <noscript>
      <style>
        #theme-toggle,
        .top-link {
          display: none;
        }
      </style>
      <style>
        @media (prefers-color-scheme: dark) {
          :root {
            --theme: rgb(29, 30, 32);
            --entry: rgb(46, 46, 51);
            --primary: rgb(218, 218, 219);
            --secondary: rgb(155, 156, 157);
            --tertiary: rgb(65, 66, 68);
            --content: rgb(196, 196, 197);
            --code-block-bg: rgb(46, 46, 51);
            --code-bg: rgb(55, 56, 62);
            --border: rgb(51, 51, 51);
          }

          .list {
            background: var(--theme);
          }

          .list:not(.dark)::-webkit-scrollbar-track {
            background: 0 0;
          }

          .list:not(.dark)::-webkit-scrollbar-thumb {
            border-color: var(--theme);
          }
        }
      </style>
    </noscript>
  </head>

  <body class="" id="top">
    <script>
      if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add("dark");
      } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove("dark");
      } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
        document.body.classList.add("dark");
      }
    </script>

    <header class="header">
      <nav class="nav">
        <div class="logo">
          <a
            href="http://localhost:1313/zh/"
            accesskey="h"
            title="simpleapples (Alt + H)"
            >simpleapples</a
          >
          <div class="logo-switches">
            <button
              id="theme-toggle"
              accesskey="t"
              title="(Alt + T)"
              aria-label="Toggle theme"
            >
              <svg
                id="moon"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                ></path>
              </svg>
              <svg
                id="sun"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
            </button>
            <ul class="lang-switch">
              <li>|</li>
              <li>
                <a
                  href="http://localhost:1313/"
                  title="English"
                  aria-label="English"
                  >En</a
                >
              </li>
            </ul>
          </div>
        </div>
        <ul id="menu">
          <li>
            <a href="http://localhost:1313/zh/about/" title="about">
              <span>about</span>
            </a>
          </li>
          <li>
            <a href="http://localhost:1313/zh/categories/" title="categories">
              <span>categories</span>
            </a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="main">
      <article class="post-single">
        <header class="post-header">
          <h1 class="post-title entry-hint-parent">
            viper从etcd读取配置失败的问题
          </h1>
          <div class="post-meta">
            <span title="2020-04-16 11:35:00 +0000 +0000">四月 16, 2020</span>
          </div>
        </header>
        <div class="post-content">
          <h3 id="问题描述">
            问题描述<a hidden class="anchor" aria-hidden="true" href="#问题描述"
              >#</a
            >
          </h3>
          <p>
            <a href="https://github.com/spf13/viper">Viper</a> （本文环境是Viper
            1.1.0）是Go应用程序的完整配置解决方案，在很多项目中都有应用。<a
              href="https://github.com/etcd-io/etcd"
              >etcd</a
            >是一个分布式KV存储，最直接的应用是配置中心。
          </p>
          <p>
            Viper除了支持从文件中读取配置，还支持从远程的配置中心读取配置，使用下面的代码进行配置。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">AddRemoteProvider</span>(<span style="color:#e6db74">&#34;etcd&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;http://127.0.0.1:2379&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;conf.toml&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">SetConfigType</span>(<span style="color:#e6db74">&#34;toml&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">ReadRemoteConfig</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
          </div>
          <p>
            运行后报错<code
              >panic: Remote Configurations Error: No Files Found</code
            >，检查后发现etcd开启了tls，所以需要用https协议访问etcd的API，更新代码如下。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">AddSecureRemoteProvider</span>(<span style="color:#e6db74">&#34;etcd&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;https://127.0.0.1:2379&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;conf.toml&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;key_path&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">SetConfigType</span>(<span style="color:#e6db74">&#34;toml&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">ReadRemoteConfig</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
          </div>
          <p>
            使用<code>AddSecureRemoteProvider</code>方法替换<code>AddRemoteProvider</code>方法，问题依旧。
          </p>
          <h3 id="定位问题">
            定位问题<a hidden class="anchor" aria-hidden="true" href="#定位问题"
              >#</a
            >
          </h3>
          <p>
            跟踪源码发现，最终像etcd发送请求的是<a
              href="https://github.com/coreos/go-etcd/"
              >go-etcd</a
            >包（目前go-etcd已经不维护），在go-etcd的requests.go文件中找到了相关的源码，go-etcd调用了net/http包向etcd发送请求。
          </p>
          <p><img loading="lazy" src="/images/20200416_01.jpg" /></p>
          <p>
            这个时候忽然想到etcd的证书是自签名的，访问自签名证书的https接口应该会报错啊，怎么会请求到内容呢？如下图，在Chrome中访问etcd的自签名https接口，会提示证书无效。
          </p>
          <p><img loading="lazy" src="/images/20200416_02.jpg" /></p>
          <p>
            我们自己使用go实现一段请求etcd
            https接口的代码，看看到底是什么回事，代码如下。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;https://127.0.0.1:2379/v2/keys/conf.toml?quorum=false&amp;recursive=false&amp;sorted=false&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// handle error</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Body</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">body</span>))
</span></span></code></pre>
          </div>
          <p>
            果然不一样，我们的代码会报错<code
              >x509: certificate signed by unknown authority</code
            >，因为是自签名证书，客户端无法验证证书真假，所以这个报错是可以理解的，go-etcd代码和我们的测试代码表现不一致，一定是我们落下了什么，重新梳理go-etcd源码终于发现了原因。
          </p>
          <p><img loading="lazy" src="/images/20200416_03.jpg" /></p>
          <p>
            在client.go文件的initHTTPSClient方法中，发现允许绕过证书验证，这就可以解释为什么证书无效也能获取到数据了，绕过了证书的验证环节，相当于不管证书真假都拿来用。现在可以解释使用<code>AddRemoteProvider</code>方法访问https接口为什么可以获取到内容，但是无法解释<code>AddSecureRemoteProvider</code>方法为什么无法从https接口获取内容，因为两个方法在发送http请求阶段的代码是一致的，都忽略了证书验证。
          </p>
          <p>查看<code>AddSecureRemoteProvider</code>的注释，发现了原因。</p>
          <p><img loading="lazy" src="/images/20200416_04.jpg" /></p>
          <p>
            原来&hellip;<code>AddSecureRemoteProvider</code>这个Secure指的并不是使用安全链接https，而是在请求到内容后加了一个解密的步骤（Secure指请求的是加密过的内容，而不是使用加密链接请求），最后一个参数接收的也并不是客户端证书，而是解密的gpg
            key&hellip; 根据viper的文档，这个gpg
            key是可选的，我们这个例子中，如果给gpg
            key传入一个空字符串，也是可以正常执行的&hellip;
          </p>
          <p>
            必须吐槽一下viper的命名，哪里是<code>AddSecureRemoteProvider</code>，明明应该叫<code
              >AddEncryptedRemoteProvider</code
            >
          </p>
          <h3 id="总结">
            总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a>
          </h3>
          <p>
            出现这个问题，主要是误会了<code>AddSecureRemoteProvider</code>接口表达的意思，并且go-etcd允许忽略证书验证，也让问题变得更加离奇。
          </p>
          <p>
            当然go-etcd的这种配置是非常合理的，内部系统使用自签名证书是一个很正常的行为。
          </p>
        </div>

        <footer class="post-footer">
          <ul class="post-tags"></ul>
        </footer>
      </article>
    </main>

    <footer class="footer">
      <span
        >&copy; 2025 <a href="http://localhost:1313/zh/">simpleapples</a></span
      >
      ·

      <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank"
          >Hugo</a
        >
        &
        <a
          href="https://github.com/adityatelange/hugo-PaperMod/"
          rel="noopener"
          target="_blank"
          >PaperMod</a
        >
      </span>
    </footer>
    <a
      href="#top"
      aria-label="go to top"
      title="Go to Top (Alt + G)"
      class="top-link"
      id="top-link"
      accesskey="g"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 12 6"
        fill="currentColor"
      >
        <path d="M12 6H0l6-6z" />
      </svg>
    </a>

    <script>
      let menu = document.getElementById("menu");
      if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
          localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        };
      }

      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
          e.preventDefault();
          var id = this.getAttribute("href").substr(1);
          if (!window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
            document
              .querySelector(`[id='${decodeURIComponent(id)}']`)
              .scrollIntoView({
                behavior: "smooth",
              });
          } else {
            document
              .querySelector(`[id='${decodeURIComponent(id)}']`)
              .scrollIntoView();
          }
          if (id === "top") {
            history.replaceState(null, null, " ");
          } else {
            history.pushState(null, null, `#${id}`);
          }
        });
      });
    </script>
    <script>
      var mybutton = document.getElementById("top-link");
      window.onscroll = function () {
        if (
          document.body.scrollTop > 800 ||
          document.documentElement.scrollTop > 800
        ) {
          mybutton.style.visibility = "visible";
          mybutton.style.opacity = "1";
        } else {
          mybutton.style.visibility = "hidden";
          mybutton.style.opacity = "0";
        }
      };
    </script>
    <script>
      document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
          document.body.classList.remove("dark");
          localStorage.setItem("pref-theme", "light");
        } else {
          document.body.classList.add("dark");
          localStorage.setItem("pref-theme", "dark");
        }
      });
    </script>
  </body>
</html>
