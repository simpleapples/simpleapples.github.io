<!DOCTYPE html>
<html lang="zh" dir="auto">
  <head>
    <script
      src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload"
      data-no-instant
      defer
    ></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="robots" content="noindex, nofollow" />
    <title>MySQL 子查询中order by不生效问题 | simpleapples</title>
    <meta name="keywords" content="" />
    <meta
      name="description"
      content="一个偶然的机会，发现一条SQL语句在不同的MySQL实例上执行得到了不同的结果。
问题描述
创建商品表product_tbl和商品操作记录表product_operation_tbl两个表，来模拟下业务场景，结构和数据如下：


接下来需要查询所有商品最新的修改时间，使用如下语句：
select t1.id, t1.name, t2.product_id, t2.created_at  from product_tbl t1 left join (select * from product_operation_log_tbl order by created_at desc) t2 on t1.id = t2.product_id group by t1.id;
通过结果可以看到，子查询先将product_operation_log_tbl里的所有记录按创建时间(created_at)逆序，然后和product_tbl进行join操作，进而查询出的商品的最新修改时间。

在区域A的MySQL实例上，查询商品最新修改时间可以得到正确结果，但是在区域B的MySQL实例上，得到的修改时间并不是最新的，而是最老的。通过对语句进行简化，发现是子查询中的order by created_at desc语句在区域B的实例上没有生效。
排查过程
难道区域会影响MySQL的行为？经过DBA排查，区域A的MySQL是5.6版，区域B的MySQL是5.7版，并且找到了这篇文章：
mysql 5.7 5.6排序_mysql 5.6升级到5.7之后 子查询里面的order排序无效_火锅与理想的博客-CSDN博客
根据文章的描述，MySQL 5.7版会忽略掉子查询中的order by语句，可令人疑惑的是，我们模拟业务场景的MySQL是8.0版，并没有出现这个问题。使用docker分别启动MySQL 5.6、5.7、8.0三个实例，来重复上面的操作，结果如下：

可以看到，只有MySQL 5.7版忽略了子查询中的order by。有没有可能是5.7引入了bug，后续版本又修复了呢？
问题根因
继续搜索文档和资料，发现官方论坛中有这样一段描述：

A &ldquo;table&rdquo; (and subquery in the FROM clause too) is - according to the SQL standard - an unordered set of rows. Rows in a table (or in a subquery in the FROM clause) do not come in any specific order. That&rsquo;s why the optimizer can ignore the ORDER BY clause that you have specified. In fact, SQL standard does not even allow the ORDER BY clause to appear in this subquery (we allow it, because ORDER BY &hellip; LIMIT &hellip; changes the result, the set of rows, not only their order).
You need to treat the subquery in the FROM clause, as a set of rows in some unspecified and undefined order, and put the ORDER BY on the top-level SELECT."
    />
    <meta name="author" content="" />
    <link
      rel="canonical"
      href="http://localhost:1313/zh/orderby-invalid-in-subquery/"
    />
    <link
      crossorigin="anonymous"
      href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css"
      integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A="
      rel="preload stylesheet"
      as="style"
    />
    <link rel="icon" href="http://localhost:1313/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="http://localhost:1313/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="http://localhost:1313/favicon-32x32.png"
    />
    <link
      rel="apple-touch-icon"
      href="http://localhost:1313/apple-touch-icon.png"
    />
    <link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg" />
    <meta name="theme-color" content="#2e2e33" />
    <meta name="msapplication-TileColor" content="#2e2e33" />
    <link
      rel="alternate"
      hreflang="zh"
      href="http://localhost:1313/zh/orderby-invalid-in-subquery/"
    />
    <noscript>
      <style>
        #theme-toggle,
        .top-link {
          display: none;
        }
      </style>
      <style>
        @media (prefers-color-scheme: dark) {
          :root {
            --theme: rgb(29, 30, 32);
            --entry: rgb(46, 46, 51);
            --primary: rgb(218, 218, 219);
            --secondary: rgb(155, 156, 157);
            --tertiary: rgb(65, 66, 68);
            --content: rgb(196, 196, 197);
            --code-block-bg: rgb(46, 46, 51);
            --code-bg: rgb(55, 56, 62);
            --border: rgb(51, 51, 51);
          }

          .list {
            background: var(--theme);
          }

          .list:not(.dark)::-webkit-scrollbar-track {
            background: 0 0;
          }

          .list:not(.dark)::-webkit-scrollbar-thumb {
            border-color: var(--theme);
          }
        }
      </style>
    </noscript>
  </head>

  <body class="" id="top">
    <script>
      if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add("dark");
      } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove("dark");
      } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
        document.body.classList.add("dark");
      }
    </script>

    <header class="header">
      <nav class="nav">
        <div class="logo">
          <a
            href="http://localhost:1313/zh/"
            accesskey="h"
            title="simpleapples (Alt + H)"
            >simpleapples</a
          >
          <div class="logo-switches">
            <button
              id="theme-toggle"
              accesskey="t"
              title="(Alt + T)"
              aria-label="Toggle theme"
            >
              <svg
                id="moon"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                ></path>
              </svg>
              <svg
                id="sun"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
            </button>
            <ul class="lang-switch">
              <li>|</li>
              <li>
                <a
                  href="http://localhost:1313/"
                  title="English"
                  aria-label="English"
                  >En</a
                >
              </li>
            </ul>
          </div>
        </div>
        <ul id="menu">
          <li>
            <a href="http://localhost:1313/zh/about/" title="about">
              <span>about</span>
            </a>
          </li>
          <li>
            <a href="http://localhost:1313/zh/categories/" title="categories">
              <span>categories</span>
            </a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="main">
      <article class="post-single">
        <header class="post-header">
          <h1 class="post-title entry-hint-parent">
            MySQL 子查询中order by不生效问题
          </h1>
          <div class="post-meta">
            <span title="2021-07-29 21:19:00 +0000 +0000">七月 29, 2021</span>
          </div>
        </header>
        <div class="post-content">
          <p>
            一个偶然的机会，发现一条SQL语句在不同的MySQL实例上执行得到了不同的结果。
          </p>
          <h1 id="问题描述">
            问题描述<a hidden class="anchor" aria-hidden="true" href="#问题描述"
              >#</a
            >
          </h1>
          <p>
            创建商品表product_tbl和商品操作记录表product_operation_tbl两个表，来模拟下业务场景，结构和数据如下：
          </p>
          <p><img loading="lazy" src="/images/20210729_01.png" /></p>
          <p><img loading="lazy" src="/images/20210729_02.png" /></p>
          <p>接下来需要查询所有商品最新的修改时间，使用如下语句：</p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> t1.id, t1.name, t2.product_id, t2.created_at  <span style="color:#66d9ef">from</span> product_tbl t1 <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> (<span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> product_operation_log_tbl <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> created_at <span style="color:#66d9ef">desc</span>) t2 <span style="color:#66d9ef">on</span> t1.id <span style="color:#f92672">=</span> t2.product_id <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> t1.id;
</span></span></code></pre>
          </div>
          <p>
            通过结果可以看到，子查询先将product_operation_log_tbl里的所有记录按创建时间(created_at)逆序，然后和product_tbl进行join操作，进而查询出的商品的最新修改时间。
          </p>
          <p><img loading="lazy" src="/images/20210729_03.png" /></p>
          <p>
            在区域A的MySQL实例上，查询商品最新修改时间可以得到正确结果，但是在区域B的MySQL实例上，得到的修改时间并不是最新的，而是最老的。通过对语句进行简化，发现是子查询中的order
            by created_at desc语句在区域B的实例上没有生效。
          </p>
          <h1 id="排查过程">
            排查过程<a hidden class="anchor" aria-hidden="true" href="#排查过程"
              >#</a
            >
          </h1>
          <p>
            难道区域会影响MySQL的行为？经过DBA排查，区域A的MySQL是5.6版，区域B的MySQL是5.7版，并且找到了这篇文章：
          </p>
          <p>
            <a
              href="https://blog.csdn.net/weixin_42121058/article/details/113588551?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-3.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-3.control"
              >mysql 5.7 5.6排序_mysql 5.6升级到5.7之后
              子查询里面的order排序无效_火锅与理想的博客-CSDN博客</a
            >
          </p>
          <p>
            根据文章的描述，MySQL 5.7版会忽略掉子查询中的order
            by语句，可令人疑惑的是，我们模拟业务场景的MySQL是8.0版，并没有出现这个问题。使用docker分别启动MySQL
            5.6、5.7、8.0三个实例，来重复上面的操作，结果如下：
          </p>
          <p><img loading="lazy" src="/images/20210729_04.png" /></p>
          <p>
            可以看到，只有MySQL 5.7版忽略了子查询中的order
            by。有没有可能是5.7引入了bug，后续版本又修复了呢？
          </p>
          <h1 id="问题根因">
            问题根因<a hidden class="anchor" aria-hidden="true" href="#问题根因"
              >#</a
            >
          </h1>
          <p>继续搜索文档和资料，发现官方论坛中有这样一段描述：</p>
          <blockquote>
            <p>
              A &ldquo;table&rdquo; (and subquery in the FROM clause too) is -
              according to the SQL standard - an unordered set of rows. Rows in
              a table (or in a subquery in the FROM clause) do not come in any
              specific order. That&rsquo;s why the optimizer can ignore the
              ORDER BY clause that you have specified. In fact, SQL standard
              does not even allow the ORDER BY clause to appear in this subquery
              (we allow it, because ORDER BY &hellip; LIMIT &hellip; changes the
              result, the set of rows, not only their order). You need to treat
              the subquery in the FROM clause, as a set of rows in some
              unspecified and undefined order, and put the ORDER BY on the
              top-level SELECT.
            </p>
          </blockquote>
          <p>
            问题的原因清晰了，原来SQL标准中，table的定义是一个未排序的数据集合，而一个SQL子查询是一个临时的table，根据这个定义，子查询中的order
            by会被忽略。同时，官方回复也给出了解决方案：将子查询的order
            by移动到最外层的select语句中。
          </p>
          <h1 id="总结">
            总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a>
          </h1>
          <ul>
            <li>在SQL标准中，子查询中的order by是不生效的</li>
            <li>
              MySQL 5.7由于在这个点上遵循了SQL标准导致问题暴露，而在MySQL
              5.6/8.0中这种写法依然是生效的
            </li>
          </ul>
          <h1 id="参考文档">
            参考文档<a hidden class="anchor" aria-hidden="true" href="#参考文档"
              >#</a
            >
          </h1>
          <p>
            <a
              href="https://stackoverflow.com/questions/26372511/mysql-mariadb-order-by-inside-subquery"
              >https://stackoverflow.com/questions/26372511/mysql-mariadb-order-by-inside-subquery</a
            >
          </p>
          <p>
            <a
              href="https://mariadb.com/kb/en/why-is-order-by-in-a-from-subquery-ignored/"
              >https://mariadb.com/kb/en/why-is-order-by-in-a-from-subquery-ignored/</a
            >
          </p>
        </div>

        <footer class="post-footer">
          <ul class="post-tags"></ul>
        </footer>
      </article>
    </main>

    <footer class="footer">
      <span
        >&copy; 2025 <a href="http://localhost:1313/zh/">simpleapples</a></span
      >
      ·

      <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank"
          >Hugo</a
        >
        &
        <a
          href="https://github.com/adityatelange/hugo-PaperMod/"
          rel="noopener"
          target="_blank"
          >PaperMod</a
        >
      </span>
    </footer>
    <a
      href="#top"
      aria-label="go to top"
      title="Go to Top (Alt + G)"
      class="top-link"
      id="top-link"
      accesskey="g"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 12 6"
        fill="currentColor"
      >
        <path d="M12 6H0l6-6z" />
      </svg>
    </a>

    <script>
      let menu = document.getElementById("menu");
      if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
          localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        };
      }

      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
          e.preventDefault();
          var id = this.getAttribute("href").substr(1);
          if (!window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
            document
              .querySelector(`[id='${decodeURIComponent(id)}']`)
              .scrollIntoView({
                behavior: "smooth",
              });
          } else {
            document
              .querySelector(`[id='${decodeURIComponent(id)}']`)
              .scrollIntoView();
          }
          if (id === "top") {
            history.replaceState(null, null, " ");
          } else {
            history.pushState(null, null, `#${id}`);
          }
        });
      });
    </script>
    <script>
      var mybutton = document.getElementById("top-link");
      window.onscroll = function () {
        if (
          document.body.scrollTop > 800 ||
          document.documentElement.scrollTop > 800
        ) {
          mybutton.style.visibility = "visible";
          mybutton.style.opacity = "1";
        } else {
          mybutton.style.visibility = "hidden";
          mybutton.style.opacity = "0";
        }
      };
    </script>
    <script>
      document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
          document.body.classList.remove("dark");
          localStorage.setItem("pref-theme", "light");
        } else {
          document.body.classList.add("dark");
          localStorage.setItem("pref-theme", "dark");
        }
      });
    </script>
  </body>
</html>
