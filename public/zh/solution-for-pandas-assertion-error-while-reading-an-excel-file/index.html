<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>探究 Pandas 读取 Excel 文件报错问题 | simpleapples</title>
<meta name="keywords" content="">
<meta name="description" content="问题描述
使用 Pandas 的 read_excel 方法读取一个 16 万行的 Excel 文件报 AssertionError 错误：
  &#34;/Users/XXX/excel_test/venv/lib/python3.7/site-packages/xlrd/xlsx.py&#34;, line 637, in do_row
    assert 0 &lt;= self.rowx &lt; X12_MAX_ROWS
AssertionError
背后原理
Excel 文件有两种默认格式，在 Excel 2007 以前，使用扩展名为 .xls 格式的文件，这种文件格式是一种特定的二进制格式，最多支持 65,536 行（在 Excel 97 之前支持的最大行数是 16,384），256 列表格。从 Excel 2007 版开始，默认采用了基于 XML 的新的文件格式 .xlsx，支持的表格行数达到了 1,048,576，列数达到了 16,384。需要注意的是，将 .xlsx 格式的文件转换为 .xls 格式的文件时，65,536 行和 256 列之后的数据都会被丢弃。

  
      
          版本
          最大行数
          最大列数
          文件格式
      
  
  
      
          Excel 97 之前
          16,384
          256
          .xls
      
      
          Excel 97 到 Excel 2003
          65,536
          256
          .xls
      
      
          Excel 2007 及以后版本
          1,048,576
          16,384
          .xlsx
      
  

Pandas 读取 Excel 文件的引擎是 xlrd，xlrd 在读取 Excel 文件时，xlrd/xlsx.py 文件的 637 行会对行号做断言，判断行号是否在 0 - 1,048,576（Excel支持的最大行数） 的范围内。这段代码是这样的：">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/zh/solution-for-pandas-assertion-error-while-reading-an-excel-file/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/zh/solution-for-pandas-assertion-error-while-reading-an-excel-file/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/zh/" accesskey="h" title="simpleapples (Alt + H)">simpleapples</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/" title="English"
                            aria-label="English">En</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/zh/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/zh/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      探究 Pandas 读取 Excel 文件报错问题
    </h1>
    <div class="post-meta"><span title='2019-08-22 15:50:00 +0000 +0000'>八月 22, 2019</span>

</div>
  </header> 
  <div class="post-content"><h3 id="问题描述">问题描述<a hidden class="anchor" aria-hidden="true" href="#问题描述">#</a></h3>
<p>使用 Pandas 的 <code>read_excel</code> 方法读取一个 16 万行的 Excel 文件报 <code>AssertionError</code> 错误：</p>
<pre tabindex="0"><code>  &#34;/Users/XXX/excel_test/venv/lib/python3.7/site-packages/xlrd/xlsx.py&#34;, line 637, in do_row
    assert 0 &lt;= self.rowx &lt; X12_MAX_ROWS
AssertionError
</code></pre><h3 id="背后原理">背后原理<a hidden class="anchor" aria-hidden="true" href="#背后原理">#</a></h3>
<p>Excel 文件有两种默认格式，在 Excel 2007 以前，使用扩展名为 <code>.xls</code> 格式的文件，这种文件格式是一种特定的二进制格式，最多支持 65,536 行（在 Excel 97 之前支持的最大行数是 16,384），256 列表格。从 Excel 2007 版开始，默认采用了基于 XML 的新的文件格式 <code>.xlsx</code>，支持的表格行数达到了 1,048,576，列数达到了 16,384。需要注意的是，将 <code>.xlsx</code> 格式的文件转换为 <code>.xls</code> 格式的文件时，65,536 行和 256 列之后的数据都会被丢弃。</p>
<table>
  <thead>
      <tr>
          <th>版本</th>
          <th>最大行数</th>
          <th>最大列数</th>
          <th>文件格式</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Excel 97 之前</td>
          <td>16,384</td>
          <td>256</td>
          <td>.xls</td>
      </tr>
      <tr>
          <td>Excel 97 到 Excel 2003</td>
          <td>65,536</td>
          <td>256</td>
          <td>.xls</td>
      </tr>
      <tr>
          <td>Excel 2007 及以后版本</td>
          <td>1,048,576</td>
          <td>16,384</td>
          <td>.xlsx</td>
      </tr>
  </tbody>
</table>
<p>Pandas 读取 Excel 文件的引擎是 <code>xlrd</code>，<code>xlrd</code> 在读取 Excel 文件时，<a href="https://github.com/python-excel/xlrd/blob/master/xlrd/xlsx.py"><code>xlrd/xlsx.py</code></a> 文件的 637 行会对行号做断言，判断行号是否在 0 - 1,048,576（Excel支持的最大行数） 的范围内。这段代码是这样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>row_number <span style="color:#f92672">=</span> row_elem<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;r&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> row_number <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>: <span style="color:#75715e"># Yes, it&#39;s optional.</span>
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>rowx <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    explicit_row_number <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>verbosity <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>warned_no_row_num:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>dumpout(<span style="color:#e6db74">&#34;no row number; assuming rowx=</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>, self<span style="color:#f92672">.</span>rowx)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>warned_no_row_num <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>rowx <span style="color:#f92672">=</span> row_number <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    explicit_row_number <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;=</span> self<span style="color:#f92672">.</span>rowx <span style="color:#f92672">&lt;</span> X12_MAX_ROWS
</span></span></code></pre></div><p>代码会从 Excel 文件中获取 row_number，这个 row_number 是每一行的行号，正常文件行号从 1 开始，而出现问题的文件行号从 0 开始，当行号为 0，进入 else 语句，导致越界问题。</p>
<h3 id="解决办法">解决办法<a hidden class="anchor" aria-hidden="true" href="#解决办法">#</a></h3>
<p>除了 <code>xlrd</code>， Pandas 还支持 <code>openpyxl</code>（0.25 版），<code>openpyxl</code> 是一个专门用来操作 <code>.xlsx</code> 格式文件的 Python 库，和 <code>xlrd</code> 相比它的速度会慢一些，但是不会碰到上面所说的问题。这是 openpyxl 中 <a href="https://bitbucket.org/openpyxl/openpyxl/src/default/openpyxl/reader/excel.py"><code>reader/excel.py</code></a> 文件处理行的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_row</span>(self, row):
</span></span><span style="display:flex;"><span>    attrs <span style="color:#f92672">=</span> dict(row<span style="color:#f92672">.</span>attrib)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;r&#34;</span> <span style="color:#f92672">in</span> attrs:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_row <span style="color:#f92672">=</span> int(attrs[<span style="color:#e6db74">&#39;r&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_row <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    keys <span style="color:#f92672">=</span> set(attrs)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> keys:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;{&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> attrs[key]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    keys <span style="color:#f92672">=</span> set(attrs)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> keys <span style="color:#f92672">!=</span> set([<span style="color:#e6db74">&#39;r&#39;</span>, <span style="color:#e6db74">&#39;spans&#39;</span>]) <span style="color:#f92672">and</span> keys <span style="color:#f92672">!=</span> set([<span style="color:#e6db74">&#39;r&#39;</span>]):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># don&#39;t create dimension objects unless they have relevant information</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>row_dimensions[attrs[<span style="color:#e6db74">&#39;r&#39;</span>]] <span style="color:#f92672">=</span> attrs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cells <span style="color:#f92672">=</span> [self<span style="color:#f92672">.</span>parse_cell(el) <span style="color:#66d9ef">for</span> el <span style="color:#f92672">in</span> row]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>max_row, cells
</span></span></code></pre></div><p>openpyxl 在处理行时，并没有对行号进行断言，即使行号第一位是 0，也不会导致报错，<strong>但这会导致第一行数据的缺失，需要进行额外处理</strong>。</p>
<h3 id="使用-pandas--openpyxl-读取-excel-文件">使用 Pandas + openpyxl 读取 Excel 文件<a hidden class="anchor" aria-hidden="true" href="#使用-pandas--openpyxl-读取-excel-文件">#</a></h3>
<p>首先安装 <code>openpyxl</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install openpyxl
</span></span></code></pre></div><p>Pandas 的 read_excel 方法中，有 <code>engine</code> 字段，可以指定所使用的处理 Excel 文件的引擎，填入 <code>openpyxl</code>，再读取文件就可以了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_excel(<span style="color:#e6db74">&#39;./data.xlsx&#39;</span>, engine<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;openpyxl&#39;</span>)
</span></span><span style="display:flex;"><span>print(len(df))  <span style="color:#75715e"># 160000</span>
</span></span></code></pre></div><h3 id="参考文档">参考文档<a hidden class="anchor" aria-hidden="true" href="#参考文档">#</a></h3>
<p><a href="https://office-watch.com/2010/excel-a-history-of-rows-and-columns/">https://office-watch.com/2010/excel-a-history-of-rows-and-columns/</a></p>
<p><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_excel.html">https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_excel.html</a></p>
<p><a href="https://github.com/python-excel/xlrd/">https://github.com/python-excel/xlrd/</a></p>
<p><a href="https://bitbucket.org/openpyxl/openpyxl/src">https://bitbucket.org/openpyxl/openpyxl/src</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/zh/">simpleapples</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
