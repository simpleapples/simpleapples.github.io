<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>gRPC 跨进程使用引发的问题 | simpleapples</title>
<meta name="keywords" content="">
<meta name="description" content="问题描述
在 Python 项目中使用 gRPC 进行通信，跨进程使用时，会出现阻塞或报错的情况（根据 gRPC.io 的版本不同，现象不同）。下面代码展示了一个跨进程使用的 DEMO，主进程向 30001 端口上的 gRPC 服务器发送请求，子进程也向相同的服务器发送请求。
def send():
    channel = grpc.insecure_channel(&#39;localhost:30001&#39;)
    stub = message_pb2_grpc.GreeterStub(channel)
    response = stub.SayHello(message_pb2.HelloRequest(name=&#39;you&#39;))
    print(f&#34;Greeter client received 1: &#34; &#43; response.message)

def main():
    channel = grpc.insecure_channel(&#39;localhost:30001&#39;)
    stub = message_pb2_grpc.GreeterStub(channel)
    response = stub.SayHello2(message_pb2.HelloRequest(name=&#39;you&#39;))
    print(&#34;Greeter client received 2: &#34; &#43; response.message)
    p = multiprocessing.Process(target=send)
    p.start()
    p.join()

if __name__ == &#39;__main__&#39;:
    main()
使用 gRPC.io 1.28.1 的情况下，会发生报错，主进程可以正常收到服务器的返回，但是子进程报 Socket operation on non-socket。
raise _InactiveRpcError(state)
grpc._channel._InactiveRpcError: &lt;_InactiveRpcError of RPC that terminated with:
        status = StatusCode.UNAVAILABLE
        details = &#34;Socket operation on non-socket&#34;
        debug_error_string = &#34;{&#34;created&#34;:&#34;@1587481625.192071231&#34;,&#34;description&#34;:&#34;Error received from peer ipv6:[::1]:50051&#34;,&#34;file&#34;:&#34;src/core/lib/surface/call.cc&#34;,&#34;file_line&#34;:1056,&#34;grpc_message&#34;:&#34;Socket operation on non-socket&#34;,&#34;grpc_status&#34;:14}&#34;
&gt;
排查过程
根据代码，主进程和子进程分别创建了自己的 Channel，看上去逻辑没什么问题，没有什么思路，所以多尝试几种情况先测试一下吧。首先尝试了一下主进程和子进程请求不同的server，在 30001 和 30002 端口分别启动两个 gRPC Server，然后将客户端代码改为主进程请求 30001 端口，子进程请求 30002 端口，代码可以正常运行。测试到这里就更摸不着头脑了，代码明明写的是主进程子进程分别创建 Channel，现在的现象看上去像是在请求相同服务器的情况下，子进程复用了主进程的socket连接。gRPC 底层使用的是 HTTP2，而 HTTP2 使用了长连接，会不会是这个原因？">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/zh/grpc-fork-support/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/zh/grpc-fork-support/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/zh/" accesskey="h" title="simpleapples (Alt + H)">simpleapples</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/" title="English"
                            aria-label="English">En</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/zh/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/zh/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      gRPC 跨进程使用引发的问题
    </h1>
    <div class="post-meta"><span title='2020-04-23 14:30:00 +0000 +0000'>四月 23, 2020</span>

</div>
  </header> 
  <div class="post-content"><h3 id="问题描述">问题描述<a hidden class="anchor" aria-hidden="true" href="#问题描述">#</a></h3>
<p>在 Python 项目中使用 gRPC 进行通信，跨进程使用时，会出现阻塞或报错的情况（根据 gRPC.io 的版本不同，现象不同）。下面代码展示了一个跨进程使用的 DEMO，主进程向 30001 端口上的 gRPC 服务器发送请求，子进程也向相同的服务器发送请求。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send</span>():
</span></span><span style="display:flex;"><span>    channel <span style="color:#f92672">=</span> grpc<span style="color:#f92672">.</span>insecure_channel(<span style="color:#e6db74">&#39;localhost:30001&#39;</span>)
</span></span><span style="display:flex;"><span>    stub <span style="color:#f92672">=</span> message_pb2_grpc<span style="color:#f92672">.</span>GreeterStub(channel)
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> stub<span style="color:#f92672">.</span>SayHello(message_pb2<span style="color:#f92672">.</span>HelloRequest(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;you&#39;</span>))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Greeter client received 1: &#34;</span> <span style="color:#f92672">+</span> response<span style="color:#f92672">.</span>message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    channel <span style="color:#f92672">=</span> grpc<span style="color:#f92672">.</span>insecure_channel(<span style="color:#e6db74">&#39;localhost:30001&#39;</span>)
</span></span><span style="display:flex;"><span>    stub <span style="color:#f92672">=</span> message_pb2_grpc<span style="color:#f92672">.</span>GreeterStub(channel)
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> stub<span style="color:#f92672">.</span>SayHello2(message_pb2<span style="color:#f92672">.</span>HelloRequest(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;you&#39;</span>))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Greeter client received 2: &#34;</span> <span style="color:#f92672">+</span> response<span style="color:#f92672">.</span>message)
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> multiprocessing<span style="color:#f92672">.</span>Process(target<span style="color:#f92672">=</span>send)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><p>使用 gRPC.io 1.28.1 的情况下，会发生报错，主进程可以正常收到服务器的返回，但是子进程报 <code>Socket operation on non-socket</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>raise _InactiveRpcError<span style="color:#f92672">(</span>state<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>grpc._channel._InactiveRpcError: &lt;_InactiveRpcError of RPC that terminated with:
</span></span><span style="display:flex;"><span>        status <span style="color:#f92672">=</span> StatusCode.UNAVAILABLE
</span></span><span style="display:flex;"><span>        details <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Socket operation on non-socket&#34;</span>
</span></span><span style="display:flex;"><span>        debug_error_string <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;{&#34;</span>created<span style="color:#e6db74">&#34;:&#34;</span>@1587481625.192071231<span style="color:#e6db74">&#34;,&#34;</span>description<span style="color:#e6db74">&#34;:&#34;</span>Error received from peer ipv6:<span style="color:#f92672">[</span>::1<span style="color:#f92672">]</span>:50051<span style="color:#e6db74">&#34;,&#34;</span>file<span style="color:#e6db74">&#34;:&#34;</span>src/core/lib/surface/call.cc<span style="color:#e6db74">&#34;,&#34;</span>file_line<span style="color:#e6db74">&#34;:1056,&#34;</span>grpc_message<span style="color:#e6db74">&#34;:&#34;</span>Socket operation on non-socket<span style="color:#e6db74">&#34;,&#34;</span>grpc_status<span style="color:#e6db74">&#34;:14}&#34;</span>
</span></span><span style="display:flex;"><span>&gt;
</span></span></code></pre></div><h3 id="排查过程">排查过程<a hidden class="anchor" aria-hidden="true" href="#排查过程">#</a></h3>
<p>根据代码，主进程和子进程分别创建了自己的 Channel，看上去逻辑没什么问题，没有什么思路，所以多尝试几种情况先测试一下吧。首先尝试了一下主进程和子进程请求不同的server，在 30001 和 30002 端口分别启动两个 gRPC Server，然后将客户端代码改为主进程请求 30001 端口，子进程请求 30002 端口，代码可以正常运行。测试到这里就更摸不着头脑了，代码明明写的是主进程子进程分别创建 Channel，现在的现象看上去<strong>像是在请求相同服务器的情况下，子进程复用了主进程的socket连接</strong>。gRPC 底层使用的是 HTTP2，而 HTTP2 使用了长连接，会不会是这个原因？</p>
<blockquote>
<p>有了新的分帧机制后，HTTP/2 不再依赖多个 TCP 连接去并行复用数据流；每个数据流都拆分成很多帧，而这些帧可以交错，还可以分别设定优先级。 因此，所有 HTTP/2 连接都是永久的，而且仅需要每个来源一个连接，随之带来诸多性能优势。 —— <a href="https://developers.google.com/web/fundamentals/performance/http2?hl=zh-cn">HTTP/2 简介</a></p></blockquote>
<p>从 HTTP2 原理上来看还是说的过去的，恰好 gRPC 项目中有 Issue 提到了跨进程使用的问题，参见 <a href="https://github.com/grpc/grpc/issues/18321">Failed to run grpc python on multiprocessing #18321</a>，开发者在其中说明了像 Demo 那样使用报错的原因。</p>
<blockquote>
<p><strong>gRPC Core&rsquo;s API for fork support</strong>
A process may fork after invoking grpc_init() and use gRPC in the child if and only if the child process first destroys all gRPC resources inherited from the parent process and invokes grpc_shutdown().
Subsequent to this, the child will be able to re-initialize and use gRPC. After fork, the parent process will be able to continue to use existing gRPC resources such as channels and calls without interference
from the child process.</p></blockquote>
<blockquote>
<p><strong>gRPC Python behavior at fork()</strong>
To facilitate gRPC Python applications meeting the above constraints, gRPC Python will automatically destroy and shutdown all gRPC Core resources in the child&rsquo;s post-fork handler, including cancelling in-flight calls. From the client&rsquo;s perspective, the child process is now free to create new channels and use gRPC.</p></blockquote>
<p>简化的说，在 gRPC Core API 的层面，子进程使用 gRPC 需要先销毁掉从父进程 fork 过来的 gRPC 资源，重新创建连接才可以正常使用，否则可能陷入死锁。</p>
<p>同时，gRPC 对于 fork 行为的支持也有一个专门的文档。<a href="https://github.com/grpc/grpc/blob/master/doc/fork_support.md">https://github.com/grpc/grpc/blob/master/doc/fork_support.md</a></p>
<blockquote>
<p>The background Python thread was removed entirely. This allows forking after creating a channel. However, the channel must not have issued any RPCs prior to the fork. Attempting to fork with an active channel that has been used can result in deadlocks/corrupted wire data.</p></blockquote>
<p>从文档和 Issue 的描述看，当主进程有活动状态的 gRPC 连接时，是不可以 fork 的，会引发死锁或者报错（可能和 HTTP2 的长连接机制有关系），如果要 fork，需要先关闭掉活动的连接，在 fork 出的子进程中重新建立 gRPC 连接（也就是主子进程各自持有各自的 HTTP2 连接）。</p>
<h3 id="实践方案">实践方案<a hidden class="anchor" aria-hidden="true" href="#实践方案">#</a></h3>
<p>综合文档和开发者在 Issue 中提到的方法，要想让 Demo 可以运行有如下三种方法。</p>
<ul>
<li>
<p>在环境变量中设置 <code>GRPC_ENABLE_FORK_SUPPORT=1</code>（参见<a href="https://github.com/grpc/grpc/blob/master/doc/fork_support.md#111">https://github.com/grpc/grpc/blob/master/doc/fork_support.md#111</a>）</p>
</li>
<li>
<p>在 fork 子进程前使用 <code>channel.close()</code> 关闭活动的 gRPC 连接（参见<a href="https://grpc.github.io/grpc/python/grpc.html#grpc.Channel.close">https://grpc.github.io/grpc/python/grpc.html#grpc.Channel.close</a>）</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    channel <span style="color:#f92672">=</span> grpc<span style="color:#f92672">.</span>insecure_channel(<span style="color:#e6db74">&#39;localhost:30001&#39;</span>)
</span></span><span style="display:flex;"><span>    stub <span style="color:#f92672">=</span> message_pb2_grpc<span style="color:#f92672">.</span>GreeterStub(channel)
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> stub<span style="color:#f92672">.</span>SayHello2(message_pb2<span style="color:#f92672">.</span>HelloRequest(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;you&#39;</span>))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Greeter client received 2: &#34;</span> <span style="color:#f92672">+</span> response<span style="color:#f92672">.</span>message)
</span></span><span style="display:flex;"><span>    channel<span style="color:#f92672">.</span>close() <span style="color:#75715e"># 关闭 channel，再 fork</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> multiprocessing<span style="color:#f92672">.</span>Process(target<span style="color:#f92672">=</span>send)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>join()
</span></span></code></pre></div><ul>
<li>使用 <code>with</code> 语句，语句结束后会自动关闭活动的 gRPC 连接（参见<a href="https://github.com/grpc/grpc/blob/master/examples/python/helloworld/greeter_client.py#L29">https://github.com/grpc/grpc/blob/master/examples/python/helloworld/greeter_client.py#L29</a>)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 使用 with 语句</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> grpc<span style="color:#f92672">.</span>insecure_channel(<span style="color:#e6db74">&#39;localhost:30001&#39;</span>) <span style="color:#66d9ef">as</span> channel:
</span></span><span style="display:flex;"><span>        stub <span style="color:#f92672">=</span> message_pb2_grpc<span style="color:#f92672">.</span>GreeterStub(channel)
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> stub<span style="color:#f92672">.</span>SayHello2(message_pb2<span style="color:#f92672">.</span>HelloRequest(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;you&#39;</span>))
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Greeter client received 2: &#34;</span> <span style="color:#f92672">+</span> response<span style="color:#f92672">.</span>message)
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> multiprocessing<span style="color:#f92672">.</span>Process(target<span style="color:#f92672">=</span>send)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>join()
</span></span></code></pre></div><h3 id="参考资料">参考资料<a hidden class="anchor" aria-hidden="true" href="#参考资料">#</a></h3>
<p><a href="https://grpc.github.io/grpc/python/grpc.html#channel-object">https://grpc.github.io/grpc/python/grpc.html#channel-object</a></p>
<p><a href="https://developers.google.com/web/fundamentals/performance/http2?hl=zh-cn">https://developers.google.com/web/fundamentals/performance/http2?hl=zh-cn</a></p>
<p><a href="https://github.com/grpc/grpc/issues/18321">https://github.com/grpc/grpc/issues/18321</a></p>
<p><a href="https://github.com/grpc/grpc/pull/16264">https://github.com/grpc/grpc/pull/16264</a></p>
<p><a href="https://github.com/grpc/grpc/blob/master/doc/fork_support.md#111">https://github.com/grpc/grpc/blob/master/doc/fork_support.md#111</a></p>
<p><a href="https://grpc.github.io/grpc/python/grpc.html#grpc.Channel.close">https://grpc.github.io/grpc/python/grpc.html#grpc.Channel.close</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/zh/">simpleapples</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
