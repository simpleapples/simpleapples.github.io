<!DOCTYPE html>
<html lang="zh" dir="auto">
  <head>
    <script
      src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload"
      data-no-instant
      defer
    ></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="robots" content="noindex, nofollow" />
    <title>搭建Kubernetes集群时DNS无法解析问题的处理过程 | simpleapples</title>
    <meta name="keywords" content="" />
    <meta
      name="description"
      content="
问题描述
在搭建Kubernetes集群过程中，安装了kube-dns插件后，运行一个ubuntu容器，发现容器内无法解析集群外域名，一开始可以解析集群内域名，一段时间后也无法解析集群内域名。
$ nslookup kubernetes.default
Server:    10.99.0.2
Address 1: 10.99.0.2 kube-dns.kube-system.svc.cluster.local

nslookup: can&#39;t resolve &#39;kubernetes.default&#39;
排查过程
在排查问题前，先思考一下Kubernetes集群中的DNS解析过程，在安装好kube-dns的集群中，普通Pod的dnsPolicy属性是默认值ClusterFirst，也就是会指向集群内部的DNS服务器，kube-dns负责解析集群内部的域名，kube-dns Pod的dnsPolicy值是Default，意思是从所在Node继承DNS服务器，对于无法解析的外部域名，kube-dns会继续向集群外部的dns进行查询，过程如图。

Ubuntu容器是一个普通的Pod，在Linux系统中，/etc/resolv.conf是存储DNS服务器的文件，普通Pod的/etc/resolv.conf文件应该存储的是kube-dns的Service IP。
nameserver 10.99.0.2  # 这里存储的是kube-dns的Service IP
search default.svc.cluster.local. svc.cluster.local. cluster.local.
options ndots:5
查看后发现/etc/resolv.conf文件中存储的是kube-dns的Service IP，证明这一步没有问题，接下来查看一下kube-dns的Pod，先进入kube-dns的Pod中检查一下/etc/resolv.conf文件，这里存储的应该是集群外部的DNS服务器地址，查看后发现，这里存储的地址是127.0.0.53，进一步查看kube-dns Pod的log，发现出现了非常多的i/o timeout错误。
 2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:38019-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:57567-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:52599-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:42539-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:46885-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:44189-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:56505-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:47320-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:42464-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:49203-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:58103-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:47148-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:36883-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:40968-&gt;127.0.0.53:53: i/o timeout
2018/07/11 07:12:47 [ERROR] 2 [www.baidu.com](http://www.baidu.com/). A: unreachable backend: read udp 127.0.0.1:55672-&gt;127.0.0.53:53: i/o timeout
现在基本上可以发现问题的原因了，kube-dns只能解析集群内部地址，而集群外部地址应该发给外部DNS服务器进行解析，由于kube-dns Pod中的/etc/resolv.conf文件存储的DNS服务器地址是127.0.0.53，127...*都是回环地址，也就是集群外域名的DNS解析请求会再次发送回kube-dns，导致形成一个循环，这也是一秒钟会出现几十次i/o timeout日志的原因，请求会不断的在kube-dns中循环，kube-dns就像一个黑洞一样，吃掉了所有dns解析请求，不断累积的请求最终会导致整个集群的网络出现卡顿。"
    />
    <meta name="author" content="" />
    <link
      rel="canonical"
      href="http://localhost:1313/zh/solving-kubernetes-dns-problem/"
    />
    <link
      crossorigin="anonymous"
      href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css"
      integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A="
      rel="preload stylesheet"
      as="style"
    />
    <link rel="icon" href="http://localhost:1313/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="http://localhost:1313/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="http://localhost:1313/favicon-32x32.png"
    />
    <link
      rel="apple-touch-icon"
      href="http://localhost:1313/apple-touch-icon.png"
    />
    <link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg" />
    <meta name="theme-color" content="#2e2e33" />
    <meta name="msapplication-TileColor" content="#2e2e33" />
    <link
      rel="alternate"
      hreflang="zh"
      href="http://localhost:1313/zh/solving-kubernetes-dns-problem/"
    />
    <noscript>
      <style>
        #theme-toggle,
        .top-link {
          display: none;
        }
      </style>
      <style>
        @media (prefers-color-scheme: dark) {
          :root {
            --theme: rgb(29, 30, 32);
            --entry: rgb(46, 46, 51);
            --primary: rgb(218, 218, 219);
            --secondary: rgb(155, 156, 157);
            --tertiary: rgb(65, 66, 68);
            --content: rgb(196, 196, 197);
            --code-block-bg: rgb(46, 46, 51);
            --code-bg: rgb(55, 56, 62);
            --border: rgb(51, 51, 51);
          }

          .list {
            background: var(--theme);
          }

          .list:not(.dark)::-webkit-scrollbar-track {
            background: 0 0;
          }

          .list:not(.dark)::-webkit-scrollbar-thumb {
            border-color: var(--theme);
          }
        }
      </style>
    </noscript>
  </head>

  <body class="" id="top">
    <script>
      if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add("dark");
      } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove("dark");
      } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
        document.body.classList.add("dark");
      }
    </script>

    <header class="header">
      <nav class="nav">
        <div class="logo">
          <a
            href="http://localhost:1313/zh/"
            accesskey="h"
            title="simpleapples (Alt + H)"
            >simpleapples</a
          >
          <div class="logo-switches">
            <button
              id="theme-toggle"
              accesskey="t"
              title="(Alt + T)"
              aria-label="Toggle theme"
            >
              <svg
                id="moon"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                ></path>
              </svg>
              <svg
                id="sun"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
            </button>
            <ul class="lang-switch">
              <li>|</li>
              <li>
                <a
                  href="http://localhost:1313/"
                  title="English"
                  aria-label="English"
                  >En</a
                >
              </li>
            </ul>
          </div>
        </div>
        <ul id="menu">
          <li>
            <a href="http://localhost:1313/zh/about/" title="about">
              <span>about</span>
            </a>
          </li>
          <li>
            <a href="http://localhost:1313/zh/categories/" title="categories">
              <span>categories</span>
            </a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="main">
      <article class="post-single">
        <header class="post-header">
          <h1 class="post-title entry-hint-parent">
            搭建Kubernetes集群时DNS无法解析问题的处理过程
          </h1>
          <div class="post-meta">
            <span title="2018-07-15 00:00:00 +0000 +0000">七月 15, 2018</span>
          </div>
        </header>
        <div class="post-content">
          <p><img loading="lazy" src="/images/20180715_01.jpg" /></p>
          <h1 id="问题描述">
            问题描述<a hidden class="anchor" aria-hidden="true" href="#问题描述"
              >#</a
            >
          </h1>
          <p>
            在搭建Kubernetes集群过程中，安装了kube-dns插件后，运行一个ubuntu容器，发现容器内无法解析集群外域名，一开始可以解析集群内域名，一段时间后也无法解析集群内域名。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ nslookup kubernetes.default
</span></span><span style="display:flex;"><span>Server:    10.99.0.2
</span></span><span style="display:flex;"><span>Address 1: 10.99.0.2 kube-dns.kube-system.svc.cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nslookup: can<span style="color:#e6db74">&#39;t resolve &#39;</span>kubernetes.default<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span></code></pre>
          </div>
          <h1 id="排查过程">
            排查过程<a hidden class="anchor" aria-hidden="true" href="#排查过程"
              >#</a
            >
          </h1>
          <p>
            在排查问题前，先思考一下Kubernetes集群中的DNS解析过程，在安装好kube-dns的集群中，普通Pod的dnsPolicy属性是默认值ClusterFirst，也就是会指向集群内部的DNS服务器，kube-dns负责解析集群内部的域名，kube-dns
            Pod的dnsPolicy值是Default，意思是从所在Node继承DNS服务器，对于无法解析的外部域名，kube-dns会继续向集群外部的dns进行查询，过程如图。
          </p>
          <p><img loading="lazy" src="/images/20180715_02.jpg" /></p>
          <p>
            Ubuntu容器是一个普通的Pod，在Linux系统中，/etc/resolv.conf是存储DNS服务器的文件，普通Pod的/etc/resolv.conf文件应该存储的是kube-dns的Service
            IP。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nameserver 10.99.0.2  <span style="color:#75715e"># 这里存储的是kube-dns的Service IP</span>
</span></span><span style="display:flex;"><span>search default.svc.cluster.local. svc.cluster.local. cluster.local.
</span></span><span style="display:flex;"><span>options ndots:5
</span></span></code></pre>
          </div>
          <p>
            查看后发现/etc/resolv.conf文件中存储的是kube-dns的Service
            IP，证明这一步没有问题，接下来查看一下kube-dns的Pod，先进入kube-dns的Pod中检查一下/etc/resolv.conf文件，这里存储的应该是集群外部的DNS服务器地址，查看后发现，这里存储的地址是127.0.0.53，进一步查看kube-dns
            Pod的log，发现出现了非常多的i/o timeout错误。
          </p>
          <div class="highlight">
            <pre
              tabindex="0"
              style="
                color: #f8f8f2;
                background-color: #272822;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
              "
            ><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> 2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:38019-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:57567-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:52599-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:42539-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:46885-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:44189-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:56505-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:47320-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:42464-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:49203-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:58103-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:47148-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:36883-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:40968-&gt;127.0.0.53:53: i/o timeout
</span></span><span style="display:flex;"><span>2018/07/11 07:12:47 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>www.baidu.com<span style="color:#f92672">](</span>http://www.baidu.com/<span style="color:#f92672">)</span>. A: unreachable backend: read udp 127.0.0.1:55672-&gt;127.0.0.53:53: i/o timeout
</span></span></code></pre>
          </div>
          <p>
            现在基本上可以发现问题的原因了，kube-dns只能解析集群内部地址，而集群外部地址应该发给外部DNS服务器进行解析，由于kube-dns
            Pod中的/etc/resolv.conf文件存储的DNS服务器地址是127.0.0.53，127.<em>.</em>.*都是回环地址，也就是集群外域名的DNS解析请求会再次发送回kube-dns，导致形成一个循环，这也是一秒钟会出现几十次i/o
            timeout日志的原因，请求会不断的在kube-dns中循环，kube-dns就像一个黑洞一样，吃掉了所有dns解析请求，不断累积的请求最终会导致整个集群的网络出现卡顿。
          </p>
          <p><img loading="lazy" src="/images/20180715_03.jpg" /></p>
          <h1 id="为什么">
            为什么<a hidden class="anchor" aria-hidden="true" href="#为什么"
              >#</a
            >
          </h1>
          <p>
            虽然问题的原因找到了，但是为什么kube-dns
            Pod中/etc/resolv.conf文件存储的DNS服务器是127.0.0.53？
          </p>
          <p>kube-dns Pod的dnsPolicy值是Default，查看一下Kubernetes文档。</p>
          <blockquote>
            <p>
              &ldquo;<code>Default</code>&rdquo;: The Pod inherits the name
              resolution configuration from the node that the pods run on.
              See <a
                href="https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/#inheriting-dns-from-the-node"
                >related discussion</a
              > for more details.
            </p>
          </blockquote>
          <p>
            所以kube-dns的/etc/resolv.conf文件是从Node中继承来的，查看Node中的/etc/resolv.conf文件，存储的DNS服务器地址确实是127.0.0.53，那么下一个问题出现了，在Node中发送DNS解析请求为什么不会产生回环的问题呢？
          </p>
          <p>
            Node使用的是Ubuntu 18.04
            Server，在这个版本的系统中，DNS解析请求并不是直接发给所在网络的DNS服务器的，Ubuntu
            18.04中有一个systemd-resolved服务，为本地应用程序提供了DNS解析服务，例如nslookup
            localhost，解析程序从/etc/resolv.conf文件中找到DNS服务器127.0.0.53，发送解析请求，systemd-resolved会监听在53端口上，捕获到解析请求后，如果是自己可以解析的，例如localhost，会直接返回127.0.0.1，如果不能解析，才会发送给外部服务器，而外部服务器的地址存储在/run/systemd/resolve/resolv.conf文件中，这个文件是systemd-resolved服务器的配置文件，过程如图。
          </p>
          <p><img loading="lazy" src="/images/20180715_04.jpg" /></p>
          <h1 id="怎么破">
            怎么破<a hidden class="anchor" aria-hidden="true" href="#怎么破"
              >#</a
            >
          </h1>
          <p>
            理解了问题的来龙去脉，解决问题的办法也就应运而生。在Kubernetes集群中，kubelet是worker组建，负责管理Pod，根据kubernetes文档，kubelet默认会从Node的/etc/resolv.conf文件读取DNS服务器地址，使得dnsPolicy是Default的Pod得以继承，kubelet中的&ndash;resolv-conf参数可以指定这个配置文件的地址。在Ubuntu
            18.04中，将这个参数设置为systemd-resolved的DNS服务器配置文件/run/systemd/resolve/resolv.conf，Pod就会继承真正的外部DNS服务器。
          </p>
          <h1 id="总结">
            总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a>
          </h1>
          <p>
            通过对问题的探究，也理解了Kubernetes集群中DNS解析的完整过程，如图。
          </p>
          <p><img loading="lazy" src="/images/20180715_05.jpg" /></p>
          <p>
            <em
              >* 在Ubuntu
              16.04中也是类似的逻辑，只不过systemd-resolved换成了dnsmasq，监听地址是127.0.1.1</em
            >
            <em
              >*
              在具体实践过程中，也顺便探究了CoreDNS和KubeDNS架构和解析逻辑上的区别，不过不在此问题的讨论范围，有兴趣的朋友可以自己看一下。</em
            >
            <em
              >*
              如果Kubernetes集群是安装在NAT网络下的虚拟机上，虚拟机（也就是Kubernetes集群中的Node）中/etc/resolv.conf文件可能被修改为NAT的地址，也就不会出现上面这个问题。</em
            >
          </p>
          <h1 id="参考内容">
            参考内容<a hidden class="anchor" aria-hidden="true" href="#参考内容"
              >#</a
            >
          </h1>
          <p>
            <a
              href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/"
              >https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/</a
            >
            <a
              href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/"
              >https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/</a
            >
            <a
              href="https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/"
              >https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/</a
            >
            <a
              href="https://www.freedesktop.org/software/systemd/man/systemd-resolved.service.html"
              >https://www.freedesktop.org/software/systemd/man/systemd-resolved.service.html</a
            >
            <a href="https://github.com/kubernetes/kubernetes/issues/49411"
              >https://github.com/kubernetes/kubernetes/issues/49411</a
            >
            <a href="https://github.com/kubernetes/kubernetes/issues/45828"
              >https://github.com/kubernetes/kubernetes/issues/45828</a
            >
          </p>
        </div>

        <footer class="post-footer">
          <ul class="post-tags"></ul>
        </footer>
      </article>
    </main>

    <footer class="footer">
      <span
        >&copy; 2025 <a href="http://localhost:1313/zh/">simpleapples</a></span
      >
      ·

      <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank"
          >Hugo</a
        >
        &
        <a
          href="https://github.com/adityatelange/hugo-PaperMod/"
          rel="noopener"
          target="_blank"
          >PaperMod</a
        >
      </span>
    </footer>
    <a
      href="#top"
      aria-label="go to top"
      title="Go to Top (Alt + G)"
      class="top-link"
      id="top-link"
      accesskey="g"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 12 6"
        fill="currentColor"
      >
        <path d="M12 6H0l6-6z" />
      </svg>
    </a>

    <script>
      let menu = document.getElementById("menu");
      if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
          localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        };
      }

      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
          e.preventDefault();
          var id = this.getAttribute("href").substr(1);
          if (!window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
            document
              .querySelector(`[id='${decodeURIComponent(id)}']`)
              .scrollIntoView({
                behavior: "smooth",
              });
          } else {
            document
              .querySelector(`[id='${decodeURIComponent(id)}']`)
              .scrollIntoView();
          }
          if (id === "top") {
            history.replaceState(null, null, " ");
          } else {
            history.pushState(null, null, `#${id}`);
          }
        });
      });
    </script>
    <script>
      var mybutton = document.getElementById("top-link");
      window.onscroll = function () {
        if (
          document.body.scrollTop > 800 ||
          document.documentElement.scrollTop > 800
        ) {
          mybutton.style.visibility = "visible";
          mybutton.style.opacity = "1";
        } else {
          mybutton.style.visibility = "hidden";
          mybutton.style.opacity = "0";
        }
      };
    </script>
    <script>
      document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
          document.body.classList.remove("dark");
          localStorage.setItem("pref-theme", "light");
        } else {
          document.body.classList.add("dark");
          localStorage.setItem("pref-theme", "dark");
        }
      });
    </script>
  </body>
</html>
